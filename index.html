<!DOCTYPE html>
<html>
  <head>
    <title>Luna Commemorative Art (LCA)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://aloycwl.github.io/js/cdn/jquery.min.js"></script>
    <script src="https://aloycwl.github.io/js/cdn/ipfs-api.min.js"></script>
    <script src="https://aloycwl.github.io/js/cdn/web3.min.js"></script>
    <script src="https://aloycwl.github.io/js/cdn/web3ac.js"></script>
    <script src="js/generative.js"></script>
  </head>
  <body>
    <h1>Luna Commemorative Art (LCA)</h1>
    Mint: <a id="loading"></a>
    <div id="mintBtns"></div>
    <div id="nfts"></div>
  </body>
  <script>
    for (i = 1; i < 11; i++)
      $('#mintBtns').append(`<button onclick='mint(${i})'>${i}</button>`);
    var loaded,
      src = 'https://ipfs.io/ipfs/';
    CHAIN = 4;
    async function mint(n) {
      waitTxt(1, 'loading');
      cnt = 0;
      count = await contract.count().call();
      $('#nfts').html('');
      ipfs = IpfsApi({
        host: 'ipfs.infura.io',
        port: 5001,
        protocol: 'https',
      });
      cidImg = new Array();
      for (i = 0; i < n; i++) {
        await drawLCA();
        cidImg[i] = await uploadJson(await uploadImg(i));
        count++;
      }
      await contract.MINT(img[0][1]).send({
        from: acct,
      });
      waitTxt(0, 'loading');
    }
    async function uploadImg(i) {
      reader = new FileReader();
      b64 = atob(
        document.getElementById(`can${i}`).toDataURL('image/png').split(',')[1]
      );
      n = b64.length;
      u8 = new Uint8Array(n);
      pro = await new Promise((d) => {
        reader.onloadend = () => {
          ipfs.add(ipfs.Buffer.from(reader.result)).then((files) => {
            d(files);
          });
        };
        while (n--) u8[n] = b64.charCodeAt(n);
        reader.readAsArrayBuffer(new File([u8], ''));
      });
      return pro[0].hash;
    }
    async function uploadJson(i) {
      pro = await new Promise((d) => {
        reader = new FileReader();
        reader.onloadend = () => {
          ipfs.add(ipfs.Buffer.from(reader.result)).then((files) => {
            d(files);
          });
        };
        reader.readAsArrayBuffer(
          new File(
            [
              `{"name":"LCA #${count}","description":"Haha to those who have invested in LUNA","image":"ipfs://${i}"}`,
            ],
            'application/json'
          )
        );
      });
      return pro[0].hash;
    }
    (async () => {
      await load(
        [
          {
            inputs: [u6],
            name: 'MINT',
            outputs: [],
            stateMutability: 'nonpayable',
            type: 'function',
          },
          {
            inputs: [],
            name: 'count',
            outputs: [u1],
            stateMutability: 'view',
            type: 'function',
          },
        ],
        '0x19e4Bd505127eeB8920104386E2828CB6A0e76c0'
      );
    })();
    $(document).ready(
      setInterval(async function () {
        if (typeof ethereum != 'undefined') {
          await web3.getAccounts().then((d) => {
            if (d.length > 0) {
              $('#root').show();
              if (!loaded) {
                loaded = true;
              }
            } else {
              $('#root').hide();
              $('#name').html(`<b>Whooli Hootie </b>`);
              $('#mint').html('MINT ');
            }
          });
        }
      }, 1000)
    );
  </script>
</html>
